<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Facial Attendance Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root{
            --bg1:#1f2833;
            --bg2:#0b0c0f;
            --accent1:#66fcf1;
            --accent2:#45a29e;
            --muted:#c5c6c7;
            --card:#1f2833;
            --warning-bg:#2f1c20;
            --warning-text:#ff7a91;
            --warning-border:#4d1e20;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            min-height:100vh;
            font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
            background: linear-gradient(135deg,var(--bg1),var(--bg2));
            color:var(--muted);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:24px;
        }

        .portal-container{
            width:100%;
            max-width:1100px;
            background:#0f1011;
            border-radius:16px;
            padding:28px;
            display:flex;
            gap:28px;
            box-shadow: 0 16px 50px rgba(0,0,0,0.6);
            flex-wrap:wrap;
        }

        .left, .right{flex:1; min-width:300px}

        .left{
            background: linear-gradient(180deg, rgba(31,40,51,0.95), rgba(25,28,34,0.9));
            border-radius:12px;
            padding:22px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }

        h1{
            margin:0 0 8px;
            color: var(--accent1);
            letter-spacing:1px;
            font-size:28px;
        }
        p.lead{
            margin:0 0 18px;
            color:var(--muted);
            opacity:0.95;
            min-height: 48px;
        }
        h2.greeting{
            color:var(--accent1);
            font-size:24px;
            margin:0 0 12px;
        }

        .steps{margin-top:10px}
        .step{display:flex;gap:12px;margin-bottom:14px}
        .bullet{
            width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;color:var(--accent2);font-weight:700;
            border:1px solid rgba(255,255,255,0.02)
        }
        .step .text{font-size:15px;color:var(--muted);line-height:1.35}

        .right{
            display:flex;
            flex-direction:column;
            align-items:center;
        }

        video{
            width:100%;
            max-width:420px;
            border-radius:12px;
            border:3px solid rgba(102,252,241,0.18);
            box-shadow:0 8px 30px rgba(102,252,241,0.06);
            background:#000;
        }

        .controls{
            margin-top:14px;
            display:flex;
            gap:12px;
            align-items:center;
            flex-wrap:wrap;
            justify-content:center;
        }

        button.primary{
            padding:12px 28px;
            background: linear-gradient(45deg,var(--accent2),var(--accent1));
            color:#071019;
            border:none;border-radius:999px;font-weight:700;cursor:pointer;
            box-shadow:0 8-px 22px rgba(102,252,241,0.08);
            transition: opacity 0.3s;
        }
        button.ghost{
            padding:10px 18px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);border-radius:999px;cursor:pointer;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.logout-btn{
            padding: 8px 16px;
            font-size: 14px;
            background: #ff5252;
            color: white;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            position: absolute;
            top: 24px;
            right: 24px;
            box-shadow: 0 4px 12px rgba(255,82,82,0.2);
            transition: transform 0.2s;
        }
        button.logout-btn:hover{transform: scale(1.05);}

        #status{
            margin-top:14px;font-weight:600;font-size:15px;text-align:center;
            min-height:22px;
        }

        /* Liveness UI */
        #livenessIndicator{display:none;margin-top:10px;align-items:center;gap:10px}
        #blinkDot{width:14px;height:14px;border-radius:50%;background:#fbc531;box-shadow:0 6px 16px rgba(251,197,49,0.12)}
        #livenessText{font-size:14px;color:var(--muted)}

        /* info card */
        .card{
            width:100%;
            max-width:420px;
            margin-top:18px;
            background:var(--card);
            border-radius:12px;
            padding:16px;
            box-shadow:0 8px 24px rgba(0,0,0,0.5);
            border:1px solid rgba(255,255,255,0.02);
            display:none;
        }
        .card .row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.03)}
        .card .row:last-child{border-bottom:none}
        .card .label{color:#9aa0a6;font-weight:600}
        .card .value{color:#e6fefb;font-weight:700}

        /* Warnings Panel */
        .warnings-panel {
            margin-top: 30px;
            padding: 18px;
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: 10px;
            text-align: left;
            animation: fadeIn 0.5s ease-in-out;
            display: none;
        }
        .warnings-panel h4 {
            margin: 0 0 10px;
            color: var(--warning-text);
            font-size: 1.2em;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--warning-text);
            padding-bottom: 5px;
        }
        .warnings-panel ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .warnings-panel li {
            margin-bottom: 15px;
            font-size: 0.9em;
            line-height: 1.5;
            color: #d1d2d3;
        }
        .warnings-panel li .warning-title {
            color: var(--warning-text);
            font-weight: bold;
            display: block;
        }

        /* Stats Card */
        #statsCard {
            width: 100%;
            max-width: 420px;
            margin-top: 18px;
            background: #141c24;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
            display: none;
            text-align: center;
        }
        #statsCard h3 {
            margin: 0 0 16px;
            color: var(--accent1);
            font-size: 20px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }
        .stat-item .stat-label {
            color: #9aa0a6;
            font-weight: 600;
            font-size: 14px;
        }
        .stat-item .stat-value {
            color: #e6fefb;
            font-weight: 700;
            font-size: 22px;
            margin-top: 4px;
        }
        .stat-item:last-child { margin-bottom: 0; }
        .grid-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
    </style>
</head>
<body>
    <button class="logout-btn" id="logoutBtn">Logout</button>
    <div class="portal-container">
        <div class="left">
            <h2 class="greeting" id="greetingText">Hi!</h2>
            <h1>Your Attendance, Secured</h1>
            <p id="leadText" class="lead">Mark attendance with live face verification. Please click 'Mark Attendance' to begin.</p>
            
            <div id="actionPanel">
                <div class="steps">
                    <div class="step">
                        <div class="bullet">1</div>
                        <div class="text"><strong>Allow Camera</strong><br>Give camera permission when asked.</div>
                    </div>

                    <div class="step">
                        <div class="bullet">2</div>
                        <div class="text"><strong>Mark Attendance</strong><br>Click the button and follow the on-screen instruction.</div>
                    </div>

                    <div class="step">
                        <div class="bullet">3</div>
                        <div class="text"><strong>Get Confirmed</strong><br>System will verify liveness and mark attendance.</div>
                    </div>
                </div>
            </div>

            <div id="statsPanel" style="display:none;">
                <p class="lead">Your attendance for today has already been marked. You can check your stats below.</p>
                <div id="statsCard">
                    <h3>Your Stats</h3>
                    <div class="grid-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Attendance</span>
                            <span class="stat-value" id="statsTotalAttendance">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Your Rank</span>
                            <span class="stat-value" id="statsRank">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="warningsPanel" class="warnings-panel">
                <h4>Warnings</h4>
                <ul id="warningsList"></ul>
            </div>
        </div>

        <div class="right">
            <div class="portal-header" style="text-align:center;margin-bottom:6px;">
                <h2 style="margin:0;color:var(--accent1);font-size:20px">Mark Your Attendance</h2>
            </div>

            <video id="webcam" autoplay playsinline muted></video>

            <div class="controls">
                <button id="markBtn" class="primary">Mark Attendance</button>
                <button id="testBtn" class="ghost" title="Quick test (no server)">Test Camera</button>
            </div>

            <div id="status"></div>

            <div id="livenessIndicator">
                <span id="blinkDot"></span>
                <span id="livenessText"></span>
            </div>

            <div id="infoCard" class="card">
                <div class="row"><div class="label">Roll No</div><div class="value" id="cardRoll">-</div></div>
                <div class="row"><div class="label">Name</div><div class="value" id="cardName">-</div></div>
                <div class="row"><div class="label">Course</div><div class="value" id="cardCourse">-</div></div>
                <div class="row"><div class="label">Total Attendance</div><div class="value" id="cardTotal">-</div></div>
                <div class="row"><div class="label">Time</div><div class="value" id="cardTime">-</div></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_ENDPOINT = "http://127.0.0.1:5000";
        const NUM_FRAMES = 12;
        const INTERVAL_MS = 150;

        // Elements
        const video = document.getElementById("webcam");
        const status = document.getElementById("status");
        const leadText = document.getElementById("leadText");
        const markBtn = document.getElementById("markBtn");
        const testBtn = document.getElementById("testBtn");
        const livenessIndicator = document.getElementById("livenessIndicator");
        const livenessText = document.getElementById("livenessText");
        const blinkDot = document.getElementById("blinkDot");
        const infoCard = document.getElementById("infoCard");
        const cardRoll = document.getElementById("cardRoll");
        const cardName = document.getElementById("cardName");
        const cardCourse = document.getElementById("cardCourse");
        const cardTotal = document.getElementById("cardTotal");
        const cardTime = document.getElementById("cardTime");
        const warningsPanel = document.getElementById("warningsPanel");
        const warningsList = document.getElementById("warningsList");
        const greetingText = document.getElementById("greetingText");
        const logoutBtn = document.getElementById("logoutBtn");
        const statsPanel = document.getElementById("statsPanel");
        const statsCard = document.getElementById("statsCard");
        const actionPanel = document.getElementById("actionPanel");
        const statsTotalAttendance = document.getElementById("statsTotalAttendance");
        const statsRank = document.getElementById("statsRank");

        // Check for student ID in local storage before starting
        const studentId = localStorage.getItem("student_id");
        if (!studentId) {
            window.location.href = "/"; // Redirect to login if not logged in
        }

        // Fetch and display student details on page load
        async function fetchStudentDetails() {
            try {
                const res = await fetch(`${BACKEND_ENDPOINT}/api/student_details/${studentId}`);
                const data = await res.json();
                
                if (data.status === "success") {
                    const studentName = data.student_details.name || "User";
                    greetingText.innerText = `Hi, ${studentName}!`;
                    
                    if (data.already_marked_today) {
                        leadText.innerText = "Your attendance for today has already been marked. You can check your stats below.";
                        actionPanel.style.display = "none";
                        statsPanel.style.display = "block";
                        statsCard.style.display = "block";
                        statsTotalAttendance.innerText = data.student_details.total_attendance || 0;
                        statsRank.innerText = `${data.rank}/${data.total_students}`;
                    } else {
                        actionPanel.style.display = "block";
                        statsPanel.style.display = "none";
                    }
                } else {
                    greetingText.innerText = "Hi!";
                    console.error("Failed to fetch student details:", data.message);
                }
            } catch (err) {
                console.error("Network error fetching student details:", err);
                greetingText.innerText = "Hi!";
            }
        }
        fetchStudentDetails();

        // Start camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = stream;
                status.innerText = "";
            } catch (err) {
                console.error("camera error", err);
                status.innerText = "❌ Could not access webcam. Check permissions.";
                status.className = "error";
            }
        }
        startCamera();

        // Liveness UI animation
        let blinkIntervalHandle = null;
        function startLivenessUI(instruction){
            livenessText.innerText = instruction;
            livenessIndicator.style.display = "flex";
            blinkDot.style.opacity = "1";
            let visible = true;
            blinkIntervalHandle = setInterval(()=> {
                blinkDot.style.opacity = visible ? "1" : "0.28";
                visible = !visible;
            }, 550);
        }
        function stopLivenessUI(){
            livenessIndicator.style.display = "none";
            if (blinkIntervalHandle) clearInterval(blinkIntervalHandle);
            blinkIntervalHandle = null;
        }

        // Add a new warning entry to the log
        function addWarning(title, message) {
            warningsPanel.style.display = "block";
            const newWarning = document.createElement("li");
            newWarning.innerHTML = `<span class="warning-title">${title}</span>${message}`;
            warningsList.appendChild(newWarning);
        }

        // Capture multiple frames and return array of blobs
        async function captureFrames(num = NUM_FRAMES, interval = INTERVAL_MS) {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            const ctx = canvas.getContext("2d");
            const frames = [];

            for (let i=0;i<num;i++){
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.8));
                frames.push(blob);
                await new Promise(r => setTimeout(r, interval));
            }
            return frames;
        }

        // Main handler
        markBtn.addEventListener("click", async () => {
            infoCard.style.display = "none";
            warningsList.innerHTML = "";
            warningsPanel.style.display = "none";
            status.className = "";
            markBtn.disabled = true;

            status.innerText = "⏳ Fetching liveness challenge...";

            try {
                const challengeResp = await fetch(`${BACKEND_ENDPOINT}/api/get_challenge`);
                const challengeData = await challengeResp.json();
                
                if (challengeData.status !== "success") {
                    status.innerText = `❌ Error: ${challengeData.message}`;
                    addWarning("Server Error", challengeData.message);
                    markBtn.disabled = false;
                    return;
                }

                const currentChallenge = challengeData.challenge;
                const instruction = challengeData.instruction;

                leadText.innerText = `Liveness challenge: ${instruction}`;
                status.innerText = `⏳ Please perform the gesture: ${instruction}`;
                
                startLivenessUI(instruction);
                const frames = await captureFrames();
                stopLivenessUI();
                
                status.innerText = `⏳ Sending frames to server for verification...`;

                const fd = new FormData();
                frames.forEach((b, idx) => fd.append(`frame_${idx}`, b, `frame_${idx}.jpg`));
                fd.append("challenge", currentChallenge);
                fd.append("student_id", studentId);

                const attendanceResp = await fetch(`${BACKEND_ENDPOINT}/api/mark_attendance`, { method:"POST", body: fd });
                const data = await attendanceResp.json();
                
                if (data?.status === "spoof_attempt") {
                    addWarning("Spoofing Detected!", data.message);
                    status.innerText = `❌ Error: ${data.message}`;
                    status.className = "error";
                } else if (data?.status === "error") {
                     addWarning("Server Error!", data?.message || "Check network connection or server logs.");
                     status.innerText = `❌ Error: ${data?.message || 'Check warnings log for details'}`;
                     status.className = "error";
                } else if (data.status === "success" || data.status === "already_marked") {
                    status.innerText = data.status === "success" ? "✅ Attendance marked" : "⏳ Already marked today";
                    status.className = data.status === "success" ? "success" : "already_marked";

                    cardRoll.textContent = data.student_id || "-";
                    cardName.textContent = data.name || "-";
                    cardCourse.textContent = data.course || "-";
                    cardTotal.textContent = data.total_attendance != null ? data.total_attendance : "-";
                    cardTime.textContent = data.time ? (new Date(data.time)).toLocaleString() : "-";
                    infoCard.style.display = "block";
                } else {
                    status.innerText = "❌ Unexpected response: " + JSON.stringify(data);
                    status.className = "error";
                }

            } catch (err) {
                console.error("network error", err);
                status.innerText = "❌ Network error or server not reachable.";
                addWarning("Network Error", "Could not reach the server.");
                status.className = "error";
            } finally {
                markBtn.disabled = false;
                leadText.innerText = "Mark attendance with live face verification. Please click 'Mark Attendance' to begin.";
            }
        });

        // Quick test button
        testBtn.addEventListener("click", async ()=>{
            status.innerText = "Testing camera... capturing one frame";
            status.className = "";
            warningsList.innerHTML = "";
            warningsPanel.style.display = "none";
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
            status.innerText = "✔ Frame captured. Camera OK.";
            setTimeout(()=>status.innerText="",2000);
        });
        
        // Logout functionality
        logoutBtn.addEventListener("click", () => {
            localStorage.removeItem("student_id");
            window.location.href = "/";
        });
    </script>
</body>
</html>